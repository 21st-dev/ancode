---
phase: 03-content-preview
plan: 01
type: execute
wave: 1
depends_on: ["02-01", "02-02"]
files_modified: [src/renderer/features/workflows/ui/workflow-preview.tsx, src/renderer/features/workflows/atoms/index.ts, src/renderer/features/layout/main-layout.tsx]
autonomous: true
---

<objective>
Create content preview panel for displaying workflow source code with syntax highlighting.

Purpose: Complete the workflow inspector by allowing users to see the full source code/file content when clicking any node in the dependency tree.

Output: Resizable preview panel with Shiki syntax highlighting, connected to tree node selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phases:
@.planning/phases/02-tree-visualization/02-01-SUMMARY.md
@.planning/phases/02-tree-visualization/02-02-SUMMARY.md

# State layer (created in 02-01):
@src/renderer/features/workflows/atoms/index.ts

# UI patterns to follow:
@src/renderer/components/ui/resizable-sidebar.tsx
@src/renderer/features/agents/ui/agent-preview.tsx
@src/renderer/features/layout/main-layout.tsx

# Tree component:
@src/renderer/features/workflows/ui/workflow-tree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preview state atoms and create WorkflowPreview component</name>
  <files>src/renderer/features/workflows/atoms/index.ts, src/renderer/features/workflows/ui/workflow-preview.tsx</files>
  <action>
**Part A: Add preview atoms to workflows/atoms/index.ts**

Add 3 new atoms:
1. **workflowsPreviewOpenAtom** - atomWithStorage<boolean> for preview panel open/closed. Storage key: "workflows:preview-open". Default: false (closed initially).
2. **workflowsPreviewWidthAtom** - atomWithStorage<number> for preview panel width. Storage key: "workflows:preview-width". Default: 400 (pixels).
3. **workflowContentPathAtom** - atom<string | null> storing the source file path to display. Updated when user clicks a tree node.

Export all 3 atoms.

**Part B: Create WorkflowPreview component**

Create src/renderer/features/workflows/ui/workflow-preview.tsx:

**Component structure:**
- Functional component receiving no props (reads atoms directly)
- Uses Shiki for syntax highlighting (already installed: `import { getHighlighter } from 'shiki'`)
- Uses fs.readfile via tRPC to fetch file content (create new tRPC procedure or use existing)
- Displays: file path header, language badge, syntax-highlighted code content
- Empty state when no file selected
- Loading state while fetching

**Shiki integration:**
- Initialize highlighter with useMemo
- Support languages: typescript, javascript, markdown, yaml (covers .md/.ts/.js files in Claude config)
- Use dark theme matching app's VS Code theme

**Error handling:**
- Show error message if file cannot be read
- Graceful fallback if Shiki fails to load (plain text with monospace font)

**Visual design:**
- Match existing sidebar patterns (border, padding, background)
- Copy code button (uses navigator.clipboard.writeText)
- Language badge in top-right
- Scrollable content area with custom scrollbar styling

Export as default.
</action>
  <verify>
- Atoms added with correct types and storage keys
- Component renders without errors
- Shiki syntax highlighting working for test content
- TypeScript compiles: bun run ts:check passes
</verify>
  <done>
Preview atoms added (open state, width, content path). WorkflowPreview component created with Shiki syntax highlighting, copy button, language badge, and proper error handling.
</done>

</task>

<task type="auto">
  <name>Task 2: Create tRPC procedure for reading workflow files and integrate preview into layout</name>
  <files>src/main/lib/trpc/routers/workflows.ts, src/renderer/features/workflows/ui/workflow-preview.tsx, src/renderer/features/layout/main-layout.tsx</files>
  <action>
**Part A: Add readFileContent procedure to workflows router**

In src/main/lib/trpc/routers/workflows.ts, add new procedure:

```typescript
readFileContent: publicProcedure
  .input(z.object({ path: z.string() }))
  .query(async ({ input }) => {
    // Validate path is within Claude config directory
    const baseDir = await getClaudeConfigDir()

    // Security: resolve both paths and ensure target is within base
    const resolvedBase = path.resolve(baseDir)
    const resolvedTarget = path.resolve(input.path)

    if (!resolvedTarget.startsWith(resolvedBase)) {
      throw new Error("Path traversal detected")
    }

    // Read file content
    return await fs.readFile(input.path, "utf-8")
  })
```

**Part B: Update WorkflowPreview to use tRPC**

Modify workflow-preview.tsx to use the new tRPC procedure:
- Use `trpc.workflows.readFileContent.useQuery({ path: contentPath })` when contentPath is not null
- Handle loading, error, and success states
- Pass content to Shiki highlighter

**Part C: Integrate preview panel into main layout**

Modify src/renderer/features/layout/main-layout.tsx:

1. Import WorkflowPreview component
2. Import workflowsPreviewOpenAtom and workflowsPreviewWidthAtom
3. Add ResizableSidebar on the right side (similar to existing preview/diff sidebars)
4. Pass open and width atoms to ResizableSidebar
5. Render WorkflowPreview as sidebar content

Position the preview sidebar to the right of the main content area, using existing layout patterns.

Follow the established pattern from how AgentPreview or other sidebars are integrated (check main-layout.tsx for existing sidebar integration code).
</action>
  <verify>
- tRPC procedure created and accessible
- WorkflowPreview fetches and displays file content correctly
- Preview panel visible in main layout
- Resizable sidebar working (drag to resize)
- Panel toggle (open/close) functional
- Build succeeds: bun run build
</verify>
  <done>
tRPC readFileContent procedure created with path validation. WorkflowPreview uses tRPC to fetch content. Preview panel integrated into main layout as resizable right sidebar. Toggle and resize working.
</done>

</task>

<task type="auto">
  <name>Task 3: Connect tree node clicks to preview</name>
  <files>src/renderer/features/workflows/ui/workflow-tree.tsx, src/renderer/features/workflows/atoms/index.ts</files>
  <action>
**Part A: Add click handler to WorkflowTree**

In src/renderer/features/workflows/ui/workflow-tree.tsx:

1. Import workflowContentPathAtom and workflowsPreviewOpenAtom
2. Add handleNodeClick function that:
   - Sets workflowContentPathAtom to the node's sourcePath
   - Sets workflowsPreviewOpenAtom to true (opens preview panel)
3. Add onClick to item nodes (agents, commands, skills) in the tree

**Part B: Update selectedWorkflowNodeAtom**

Also update selectedWorkflowNodeAtom when node is clicked, so both atoms are in sync. This atom already exists from 02-01.

The click handler should be on the clickable tree item rows (where name/description are displayed), not on expand/collapse chevons.
</action>
  <verify>
- Clicking agent/command/skill opens preview panel
- Preview panel shows correct file content
- Syntax highlighting applied based on file type
- Clicking expand/collapse doesn't trigger preview
- Multiple clicks work correctly (updates preview)
</verify>
  <done>
Tree node clicks connected to preview. Clicking agent/command/skill opens preview panel with their source content. Expand/collapse still works independently. selectedWorkflowNodeAtom updated on click.
</done>

</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Preview atoms added with storage persistence
- [ ] readFileContent tRPC procedure created with security validation
- [ ] WorkflowPreview component with Shiki syntax highlighting
- [ ] Preview panel integrated as resizable right sidebar
- [ ] Tree node clicks open preview with correct content
- [ ] Copy code button functional
- [ ] Build succeeds: bun run build
- [ ] TypeScript compiles: bun run ts:check
- [ ] Full end-to-end flow works (click node â†’ see preview)
</verification>

<success_criteria>

- All 3 tasks completed
- Preview panel displays workflow file contents with syntax highlighting
- Panel is resizable and toggleable
- Tree interaction complete (click to preview, expand/collapse independent)
- Feature complete and functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-preview/03-01-SUMMARY.md`
</output>
