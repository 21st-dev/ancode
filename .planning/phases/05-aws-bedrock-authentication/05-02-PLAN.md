---
phase: 05-aws-bedrock-authentication
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/main/lib/trpc/routers/aws-sso.ts
  - src/main/lib/trpc/index.ts
autonomous: true

must_haves:
  truths:
    - "Renderer can initiate AWS SSO device authorization via tRPC"
    - "Renderer can poll for device authorization completion"
    - "Renderer can retrieve list of AWS accounts and roles"
    - "Renderer can save selected AWS SSO profile to database"
    - "Saved profile data is retrievable for Claude SDK configuration"
  artifacts:
    - path: "src/main/lib/trpc/routers/aws-sso.ts"
      provides: "tRPC router for AWS SSO operations"
      exports: ["awsSsoRouter"]
      min_lines: 150
    - path: "src/main/lib/trpc/index.ts"
      provides: "Router registration for AWS SSO"
      contains: "awsSso: awsSsoRouter"
  key_links:
    - from: "src/main/lib/trpc/routers/aws-sso.ts"
      to: "src/main/lib/aws-sso-client.ts"
      via: "import and call performDeviceAuthorization, pollForToken, listAccountsAndRoles"
      pattern: "import.*performDeviceAuthorization.*from.*aws-sso-client"
    - from: "src/main/lib/trpc/routers/aws-sso.ts"
      to: "src/main/lib/db/schema/index.ts"
      via: "update claudeCodeSettings table"
      pattern: "db\\.update\\(claudeCodeSettings\\)"
    - from: "src/main/lib/trpc/index.ts"
      to: "src/main/lib/trpc/routers/aws-sso.ts"
      via: "router registration"
      pattern: "awsSso:.*awsSsoRouter"
---

<objective>
Create tRPC backend procedures for AWS SSO authentication flow, enabling the renderer process to initiate device authorization, poll for completion, list accounts/roles, and save selected profiles to the database.

Purpose: Provide type-safe IPC layer between Electron renderer and main process for AWS SSO operations. This follows the project's established pattern of using tRPC for all mainâ†”renderer communication instead of raw IPC handlers.

Output: A complete tRPC router with procedures for startDeviceAuth, pollDeviceAuth, listAccounts, and saveProfile. Router integrated into main tRPC router export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-aws-bedrock-authentication/05-RESEARCH.md
@.planning/phases/05-aws-bedrock-authentication/05-01-SUMMARY.md

# Current tRPC patterns
@src/main/lib/trpc/index.ts
@src/main/lib/trpc/routers/claude-settings.ts

# Database schema
@src/main/lib/db/schema/index.ts

# AWS SSO client (from Plan 01)
@src/main/lib/aws-sso-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AWS SSO tRPC router</name>
  <files>
    src/main/lib/trpc/routers/aws-sso.ts
  </files>
  <action>
Create tRPC router at src/main/lib/trpc/routers/aws-sso.ts with four procedures:

**Imports:**
```typescript
import { z } from "zod"
import { router, publicProcedure } from "../index"
import { getDatabase, claudeCodeSettings } from "../../db"
import { eq } from "drizzle-orm"
import {
  performDeviceAuthorization,
  pollForToken,
  listAccountsAndRoles,
  cacheSsoToken,
  loadCachedSsoToken,
  type DeviceAuthResult,
  type TokenResult,
  type AccountWithRoles
} from "../../aws-sso-client"
```

**1. startDeviceAuth procedure:**
- Input: z.object({ ssoStartUrl: z.string().url(), ssoRegion: z.string() })
- Call performDeviceAuthorization(ssoStartUrl, ssoRegion, "1Code Desktop")
- Return DeviceAuthResult (deviceCode, verificationUriComplete, expiresIn, interval, clientId, clientSecret)
- Store clientId/clientSecret in memory for pollDeviceAuth (use Map with sessionId key)
- Error handling: Catch AWS SDK errors, return TRPCError with descriptive message

**2. pollDeviceAuth procedure:**
- Input: z.object({ sessionId: z.string(), deviceCode: z.string(), interval: z.number(), expiresAt: z.string() })
- Retrieve clientId/clientSecret from memory using sessionId
- Call pollForToken(clientId, clientSecret, deviceCode, interval, new Date(expiresAt))
- On success: Cache token using cacheSsoToken
- Return: { success: boolean, accessToken?: string, expiresAt?: string }
- Error handling: Return { success: false } on timeout/errors, not throw (UI handles retry)

**3. listAccounts procedure:**
- Input: z.object({ accessToken: z.string(), ssoRegion: z.string() })
- Call listAccountsAndRoles(accessToken, ssoRegion)
- Return: AccountWithRoles[]
- Error handling: Catch AWS SDK errors, return TRPCError with message

**4. saveProfile procedure:**
- Input: z.object({
    ssoStartUrl: z.string().url(),
    ssoRegion: z.string(),
    accountId: z.string(),
    roleName: z.string(),
    sessionName: z.string().optional()
  })
- Update claudeCodeSettings table (id: "default") with AWS SSO fields
- Set authMode to "aws" if not already
- Return: Updated settings object
- Error handling: Catch database errors, return TRPCError

**Export:**
```typescript
export const awsSsoRouter = router({
  startDeviceAuth: publicProcedure.input(...).mutation(...),
  pollDeviceAuth: publicProcedure.input(...).query(...),
  listAccounts: publicProcedure.input(...).query(...),
  saveProfile: publicProcedure.input(...).mutation(...)
})
```

**Memory management for clientId/clientSecret:**
- Use module-level Map<string, { clientId: string, clientSecret: string }>
- Session TTL: 10 minutes (device auth expires in ~10 min)
- Clean up expired sessions on each startDeviceAuth call

**Pattern from codebase:** Follow claude-settings.ts structure - use getDatabase(), publicProcedure, z.object validation, TRPCError for errors.

**Why publicProcedure:** No authentication required for SSO configuration (this IS the authentication setup).
  </action>
  <verify>
1. Run: `bun run build` and verify TypeScript compilation succeeds
2. Check exports: awsSsoRouter exported from file
3. Check procedures: startDeviceAuth, pollDeviceAuth, listAccounts, saveProfile all defined
4. Verify imports: aws-sso-client functions imported
  </verify>
  <done>
tRPC router created with 4 procedures. startDeviceAuth initiates device flow. pollDeviceAuth polls for token. listAccounts retrieves AWS accounts/roles. saveProfile persists configuration to database. All procedures use Zod validation, error handling with TRPCError, and follow project tRPC patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register AWS SSO router in main tRPC router</name>
  <files>
    src/main/lib/trpc/index.ts
  </files>
  <action>
Integrate AWS SSO router into main tRPC router:

1. Open src/main/lib/trpc/index.ts
2. Add import: `import { awsSsoRouter } from "./routers/aws-sso"`
3. Add to router definition in createRouter() call:
   ```typescript
   awsSso: awsSsoRouter,
   ```
4. Verify alphabetical ordering with other routers (if that's the convention)

**Pattern:** Follow existing pattern in index.ts - import router, add to createRouter() object.

**Why needed:** tRPC requires explicit router registration. Without this, renderer cannot call awsSso.* procedures.
  </action>
  <verify>
1. Check src/main/lib/trpc/index.ts contains import for awsSsoRouter
2. Check router definition includes `awsSso: awsSsoRouter`
3. Run: `bun run build` and verify no TypeScript errors
4. Check type exports: Verify `trpc.awsSso.*` is accessible (types should auto-generate)
  </verify>
  <done>
AWS SSO router registered in main tRPC router. Import added. Router definition updated. TypeScript compilation succeeds. Renderer can now call trpc.awsSso.startDeviceAuth, trpc.awsSso.pollDeviceAuth, trpc.awsSso.listAccounts, trpc.awsSso.saveProfile with full type safety.
  </done>
</task>

</tasks>

<verification>
1. tRPC router file exists: `ls src/main/lib/trpc/routers/aws-sso.ts`
2. Router exported: `grep "export const awsSsoRouter" src/main/lib/trpc/routers/aws-sso.ts`
3. Main router imports it: `grep "awsSsoRouter" src/main/lib/trpc/index.ts`
4. TypeScript compilation succeeds: `bun run build`
5. All 4 procedures defined: `grep -E "(startDeviceAuth|pollDeviceAuth|listAccounts|saveProfile)" src/main/lib/trpc/routers/aws-sso.ts | wc -l` returns at least 4
</verification>

<success_criteria>
- [x] src/main/lib/trpc/routers/aws-sso.ts created with awsSsoRouter export
- [x] startDeviceAuth procedure initiates device authorization flow
- [x] pollDeviceAuth procedure polls for token with clientId/clientSecret memory management
- [x] listAccounts procedure retrieves AWS accounts and roles
- [x] saveProfile procedure persists AWS SSO configuration to database
- [x] All procedures use Zod input validation
- [x] Error handling with TRPCError for all AWS SDK and database operations
- [x] Router registered in src/main/lib/trpc/index.ts
- [x] TypeScript compilation succeeds with full type safety
</success_criteria>

<output>
After completion, create `.planning/phases/05-aws-bedrock-authentication/05-02-SUMMARY.md` following the summary template with:
- Frontmatter: requires 05-01, provides tRPC backend for AWS SSO, affects onboarding and settings UI
- Description of tRPC procedures created
- Memory management approach for clientId/clientSecret
- Any deviations from plan
</output>
