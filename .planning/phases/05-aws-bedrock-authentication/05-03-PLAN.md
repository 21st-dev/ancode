---
phase: 05-aws-bedrock-authentication
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/renderer/features/onboarding/anthropic-onboarding-page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select AWS SSO auth mode in onboarding"
    - "User can enter SSO portal URL and region"
    - "User sees device verification URL when auth starts"
    - "User can open verification URL in browser"
    - "UI polls for device authorization completion"
    - "User sees list of available AWS accounts and roles"
    - "User can select account/role for Bedrock access"
    - "Onboarding completes with saved AWS SSO profile"
  artifacts:
    - path: "src/renderer/features/onboarding/anthropic-onboarding-page.tsx"
      provides: "AWS SSO authentication flow in onboarding"
      contains: "authMode === \"aws\""
      min_lines: 400
  key_links:
    - from: "src/renderer/features/onboarding/anthropic-onboarding-page.tsx"
      to: "trpc.awsSso.startDeviceAuth"
      via: "useMutation hook"
      pattern: "trpc\\.awsSso\\.startDeviceAuth\\.useMutation"
    - from: "src/renderer/features/onboarding/anthropic-onboarding-page.tsx"
      to: "trpc.awsSso.pollDeviceAuth"
      via: "useQuery hook with refetchInterval"
      pattern: "trpc\\.awsSso\\.pollDeviceAuth\\.useQuery"
    - from: "src/renderer/features/onboarding/anthropic-onboarding-page.tsx"
      to: "trpc.awsSso.listAccounts"
      via: "useMutation hook after successful auth"
      pattern: "trpc\\.awsSso\\.listAccounts"
    - from: "src/renderer/features/onboarding/anthropic-onboarding-page.tsx"
      to: "trpc.awsSso.saveProfile"
      via: "useMutation hook on profile selection"
      pattern: "trpc\\.awsSso\\.saveProfile"
---

<objective>
Add AWS SSO authentication flow to the onboarding page, allowing new users to configure AWS SSO credentials for Bedrock API access during initial setup.

Purpose: Enable first-time users to authenticate with AWS SSO and select an AWS account/role for Bedrock API access. This provides an alternative to OAuth for users who need Bedrock (Amazon's Claude API service) instead of direct Anthropic API access.

Output: Updated onboarding page with AWS SSO configuration form, device authorization flow UI, account/role selection dropdown, and profile save functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-aws-bedrock-authentication/05-RESEARCH.md
@.planning/phases/05-aws-bedrock-authentication/05-01-SUMMARY.md
@.planning/phases/05-aws-bedrock-authentication/05-02-SUMMARY.md

# Current onboarding implementation
@src/renderer/features/onboarding/anthropic-onboarding-page.tsx

# UI components
@src/renderer/components/ui/input.tsx
@src/renderer/components/ui/button.tsx
@src/renderer/components/ui/label.tsx
@src/renderer/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AWS SSO form to onboarding</name>
  <files>
    src/renderer/features/onboarding/anthropic-onboarding-page.tsx
  </files>
  <action>
Update anthropic-onboarding-page.tsx to add AWS SSO authentication flow:

**1. State management (add after existing state at line ~44):**
```typescript
// AWS SSO state
const [ssoStartUrl, setSsoStartUrl] = useState("https://d-9067694978.awsapps.com/start")
const [ssoRegion, setSsoRegion] = useState("us-east-1")
const [deviceAuthData, setDeviceAuthData] = useState<{
  deviceCode: string
  verificationUriComplete: string
  interval: number
  expiresAt: Date
  sessionId: string
  clientId: string
  clientSecret: string
} | null>(null)
const [accessToken, setAccessToken] = useState<string | null>(null)
const [accounts, setAccounts] = useState<Array<{
  accountId: string
  accountName: string
  roles: Array<{ roleName: string; accountId: string }>
}>>([])
const [selectedAccountId, setSelectedAccountId] = useState<string>("")
const [selectedRoleName, setSelectedRoleName] = useState<string>("")
```

**2. tRPC mutations (add after existing mutations at line ~50):**
```typescript
const startDeviceAuthMutation = trpc.awsSso.startDeviceAuth.useMutation()
const listAccountsMutation = trpc.awsSso.listAccounts.useMutation()
const saveProfileMutation = trpc.awsSso.saveProfile.useMutation()
```

**3. Device auth polling (add after existing useQuery at line ~59):**
```typescript
const pollDeviceAuthQuery = trpc.awsSso.pollDeviceAuth.useQuery(
  {
    sessionId: deviceAuthData?.sessionId || "",
    deviceCode: deviceAuthData?.deviceCode || "",
    interval: deviceAuthData?.interval || 5,
    expiresAt: deviceAuthData?.expiresAt.toISOString() || ""
  },
  {
    enabled: deviceAuthData !== null && accessToken === null,
    refetchInterval: (deviceAuthData?.interval || 5) * 1000,
  }
)
```

**4. Handle successful device auth (add useEffect):**
```typescript
useEffect(() => {
  if (pollDeviceAuthQuery.data?.success && pollDeviceAuthQuery.data.accessToken) {
    setAccessToken(pollDeviceAuthQuery.data.accessToken)
    // Immediately fetch accounts
    listAccountsMutation.mutate(
      { accessToken: pollDeviceAuthQuery.data.accessToken, ssoRegion },
      {
        onSuccess: (data) => {
          setAccounts(data)
        }
      }
    )
  }
}, [pollDeviceAuthQuery.data])
```

**5. UI rendering (update return JSX after authMode tabs):**

Add AWS tab content:
```tsx
{authMode === "aws" && (
  <div className="space-y-4">
    <div>
      <Label htmlFor="sso-start-url">SSO Portal URL</Label>
      <Input
        id="sso-start-url"
        type="url"
        value={ssoStartUrl}
        onChange={(e) => setSsoStartUrl(e.target.value)}
        placeholder="https://d-XXXXXXXXXX.awsapps.com/start"
      />
    </div>

    <div>
      <Label htmlFor="sso-region">SSO Region</Label>
      <Input
        id="sso-region"
        value={ssoRegion}
        onChange={(e) => setSsoRegion(e.target.value)}
        placeholder="us-east-1"
      />
    </div>

    {!deviceAuthData && !accessToken && (
      <Button
        onClick={async () => {
          const result = await startDeviceAuthMutation.mutateAsync({
            ssoStartUrl,
            ssoRegion
          })
          setDeviceAuthData({
            ...result,
            expiresAt: new Date(Date.now() + result.expiresIn * 1000),
            sessionId: crypto.randomUUID()
          })
          // Open browser to verification URL
          window.open(result.verificationUriComplete, "_blank")
        }}
        disabled={startDeviceAuthMutation.isPending}
      >
        {startDeviceAuthMutation.isPending ? "Starting..." : "Authenticate with AWS SSO"}
      </Button>
    )}

    {deviceAuthData && !accessToken && (
      <div className="rounded-md border p-4">
        <p className="text-sm">Complete authentication in your browser:</p>
        <a
          href={deviceAuthData.verificationUriComplete}
          target="_blank"
          rel="noopener noreferrer"
          className="text-blue-500 underline"
        >
          {deviceAuthData.verificationUriComplete}
        </a>
        <p className="mt-2 text-xs text-muted-foreground">
          {pollDeviceAuthQuery.isFetching ? "Waiting for authentication..." : "Polling..."}
        </p>
      </div>
    )}

    {accessToken && accounts.length > 0 && (
      <div className="space-y-3">
        <div>
          <Label htmlFor="account-select">AWS Account</Label>
          <select
            id="account-select"
            value={selectedAccountId}
            onChange={(e) => {
              setSelectedAccountId(e.target.value)
              setSelectedRoleName("") // Reset role when account changes
            }}
            className="w-full rounded-md border p-2"
          >
            <option value="">Select account...</option>
            {accounts.map((account) => (
              <option key={account.accountId} value={account.accountId}>
                {account.accountName} ({account.accountId})
              </option>
            ))}
          </select>
        </div>

        {selectedAccountId && (
          <div>
            <Label htmlFor="role-select">IAM Role</Label>
            <select
              id="role-select"
              value={selectedRoleName}
              onChange={(e) => setSelectedRoleName(e.target.value)}
              className="w-full rounded-md border p-2"
            >
              <option value="">Select role...</option>
              {accounts
                .find((a) => a.accountId === selectedAccountId)
                ?.roles.map((role) => (
                  <option key={role.roleName} value={role.roleName}>
                    {role.roleName}
                  </option>
                ))}
            </select>
          </div>
        )}

        {selectedAccountId && selectedRoleName && (
          <Button
            onClick={async () => {
              await saveProfileMutation.mutateAsync({
                ssoStartUrl,
                ssoRegion,
                accountId: selectedAccountId,
                roleName: selectedRoleName
              })
              setAnthropicOnboardingCompleted(true)
            }}
            disabled={saveProfileMutation.isPending}
          >
            {saveProfileMutation.isPending ? "Saving..." : "Complete Setup"}
          </Button>
        )}
      </div>
    )}
  </div>
)}
```

**Pattern from current code:** Follow existing OAuth flow structure - state management, mutations, polling with useQuery, conditional rendering based on flow state.

**Why default SSO URL:** https://d-9067694978.awsapps.com/start is Vidyard's SSO portal (mentioned in roadmap). Provides good default for Vidyard developers, but users can change it.

**Why separate SSO region from Bedrock region:** SSO region is where IAM Identity Center is hosted (typically us-east-1). Bedrock region is set separately in settings (where models are available, e.g., us-west-2).
  </action>
  <verify>
1. Run: `bun run dev` and navigate to onboarding page
2. Verify "AWS SSO" tab is visible alongside OAuth/API Key tabs
3. Check form renders with SSO Portal URL and SSO Region inputs
4. Verify "Authenticate with AWS SSO" button is present
5. Check TypeScript compilation succeeds: `bun run build`
  </verify>
  <done>
AWS SSO authentication flow added to onboarding. Form includes SSO portal URL and region inputs. Device authorization flow initiates on button click. UI polls for auth completion. Account/role selection dropdowns render after successful authentication. Profile save completes onboarding. All state managed with React hooks. tRPC mutations handle backend communication.
  </done>
</task>

</tasks>

<verification>
1. File updated: `git diff src/renderer/features/onboarding/anthropic-onboarding-page.tsx` shows AWS SSO additions
2. TypeScript compilation: `bun run build` succeeds
3. AWS SSO state variables: grep "ssoStartUrl\|deviceAuthData\|accessToken" in file
4. tRPC mutations: grep "awsSso\\.startDeviceAuth\|awsSso\\.listAccounts\|awsSso\\.saveProfile" in file
5. Polling setup: grep "pollDeviceAuth.*useQuery.*refetchInterval" in file
6. UI elements: grep "authMode === \"aws\"" and verify JSX block exists
</verification>

<success_criteria>
- [x] AWS SSO state variables added (ssoStartUrl, ssoRegion, deviceAuthData, accessToken, accounts, selectedAccountId, selectedRoleName)
- [x] tRPC mutations added (startDeviceAuth, listAccounts, saveProfile)
- [x] Device auth polling implemented with useQuery and refetchInterval
- [x] useEffect handles successful auth and triggers account listing
- [x] Form UI renders with SSO portal URL and region inputs
- [x] Device auth flow UI shows verification URL and polling status
- [x] Account and role selection dropdowns render after auth
- [x] Complete Setup button saves profile and completes onboarding
- [x] TypeScript compilation succeeds
- [x] Browser window opens automatically to verification URL
</success_criteria>

<output>
After completion, create `.planning/phases/05-aws-bedrock-authentication/05-03-SUMMARY.md` following the summary template with:
- Frontmatter: requires 05-02, provides onboarding AWS SSO flow, affects new user setup
- Description of UI flow added
- State management approach
- Any UX considerations or edge cases handled
</output>
