---
phase: 05-aws-bedrock-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - drizzle/meta/_journal.json
  - src/main/lib/db/schema/index.ts
  - package.json
  - bun.lock
  - src/main/lib/aws-sso-client.ts
autonomous: true

must_haves:
  truths:
    - "AWS SSO fields exist in claudeCodeSettings table"
    - "AWS SDK packages are installed and importable"
    - "AWS SSO client can perform device authorization flow"
    - "AWS SSO client can list accounts and roles for authenticated user"
    - "SSO tokens are cached to ~/.aws/sso/cache/ in AWS CLI format"
  artifacts:
    - path: "drizzle/XXXX_add_aws_sso_fields.sql"
      provides: "Database migration adding AWS SSO fields"
      contains: "ALTER TABLE claude_code_settings ADD COLUMN aws_sso_start_url"
    - path: "src/main/lib/db/schema/index.ts"
      provides: "Updated schema with AWS SSO fields"
      exports: ["claudeCodeSettings"]
      min_lines: 135
    - path: "package.json"
      provides: "AWS SDK v3 package declarations"
      contains: "@aws-sdk/client-sso-oidc"
    - path: "src/main/lib/aws-sso-client.ts"
      provides: "AWS SSO authentication client"
      exports: ["performDeviceAuthorization", "listAccountsAndRoles", "cacheSsoToken", "loadCachedSsoToken"]
      min_lines: 200
  key_links:
    - from: "src/main/lib/aws-sso-client.ts"
      to: "@aws-sdk/client-sso-oidc"
      via: "import SSOOIDCClient"
      pattern: "import.*SSOOIDCClient.*from.*@aws-sdk/client-sso-oidc"
    - from: "src/main/lib/aws-sso-client.ts"
      to: "@aws-sdk/client-sso"
      via: "import SSOClient"
      pattern: "import.*SSOClient.*from.*@aws-sdk/client-sso"
    - from: "src/main/lib/aws-sso-client.ts"
      to: "~/.aws/sso/cache"
      via: "fs.writeFile for token caching"
      pattern: "path\\.join\\(os\\.homedir\\(\\), \"\\.aws\", \"sso\", \"cache\""
---

<objective>
Establish AWS SSO authentication foundation by adding database fields, installing AWS SDK packages, and implementing the core SSO client for device authorization and account listing.

Purpose: Enable AWS SSO authentication flow for Bedrock API access by implementing the OAuth2 device authorization grant pattern that AWS CLI uses. This allows users to authenticate via browser and obtain temporary credentials for Bedrock API calls.

Output: Database migration with AWS SSO fields, AWS SDK v3 packages installed, and a complete AWS SSO client module that handles device flow, account/role listing, and token caching compatible with AWS CLI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-aws-bedrock-authentication/05-RESEARCH.md

# Current authentication implementation
@src/main/lib/db/schema/index.ts
@src/main/lib/claude/env.ts
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for AWS SSO fields</name>
  <files>
    drizzle/meta/_journal.json
    src/main/lib/db/schema/index.ts
  </files>
  <action>
Add AWS SSO fields to the claudeCodeSettings table schema:

1. Open src/main/lib/db/schema/index.ts
2. Add new fields to claudeCodeSettings table definition (after bedrockRegion field):
   - awsSsoStartUrl: text("aws_sso_start_url") - SSO portal URL
   - awsSsoRegion: text("aws_sso_region").notNull().default("us-east-1") - IAM Identity Center region
   - awsSsoAccountId: text("aws_sso_account_id") - Selected AWS account ID
   - awsSsoRoleName: text("aws_sso_role_name") - Selected IAM role name
   - awsSsoSessionName: text("aws_sso_session_name") - Optional session name for AWS config

3. Generate migration: `bun run db:generate`
4. Verify migration file created in drizzle/ folder contains ALTER TABLE statements for all 5 new fields
5. Apply migration: `bun run db:push`

**Pattern from research:** Store SSO configuration (startUrl, region, accountId, roleName) not the access tokens (which expire). Tokens are cached separately in ~/.aws/sso/cache/ using AWS CLI format for compatibility.

**Why separate ssoRegion from bedrockRegion:** SSO OIDC client region must match IAM Identity Center region (where SSO portal is hosted). Bedrock client region must match where Bedrock models are available. These are often different (SSO in us-east-1, Bedrock in us-west-2).
  </action>
  <verify>
1. Check drizzle/meta/_journal.json has new migration entry
2. Check src/main/lib/db/schema/index.ts contains all 5 new fields
3. Run: `sqlite3 ~/Library/Application\ Support/Agents\ Dev/data/agents.db ".schema claude_code_settings"` and verify columns exist
  </verify>
  <done>
Migration applied successfully. claudeCodeSettings table has awsSsoStartUrl, awsSsoRegion, awsSsoAccountId, awsSsoRoleName, awsSsoSessionName columns. Schema file exports updated ClaudeCodeSettings type with new fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install AWS SDK v3 packages</name>
  <files>
    package.json
    bun.lock
  </files>
  <action>
Install AWS SDK v3 packages for SSO authentication:

1. Run: `bun add @aws-sdk/client-sso-oidc @aws-sdk/client-sso @aws-sdk/client-bedrock-runtime @aws-sdk/credential-providers`

2. Verify versions in package.json are 3.x (likely 3.971.x or similar based on research)

**Why these packages:**
- @aws-sdk/client-sso-oidc: Device authorization flow (OAuth2 device grant)
- @aws-sdk/client-sso: List accounts/roles, get temporary credentials
- @aws-sdk/client-bedrock-runtime: Bedrock API client (for future use)
- @aws-sdk/credential-providers: Credential resolution helpers (fromSSO, etc.)

**Why NOT AWS SDK v2:** v3 is modular (smaller bundles), better TypeScript support, officially recommended by AWS since 2020.
  </action>
  <verify>
Run: `bun pm ls | grep @aws-sdk` and confirm all 4 packages are listed with 3.x versions
  </verify>
  <done>
AWS SDK v3 packages installed. package.json lists @aws-sdk/client-sso-oidc, @aws-sdk/client-sso, @aws-sdk/client-bedrock-runtime, @aws-sdk/credential-providers with 3.x versions. Dependencies are in bun.lock.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement AWS SSO client</name>
  <files>
    src/main/lib/aws-sso-client.ts
  </files>
  <action>
Create AWS SSO authentication client at src/main/lib/aws-sso-client.ts with four exported functions following research patterns:

**1. performDeviceAuthorization(ssoStartUrl, ssoRegion, clientName?)**
- Import: SSOOIDCClient, RegisterClientCommand, StartDeviceAuthorizationCommand, CreateTokenCommand
- Register client (public, scopes: ["sso:account:access"])
- Start device authorization
- Return: { deviceCode, verificationUriComplete, expiresIn, interval, clientId, clientSecret }
- Do NOT poll in this function - return device auth response for UI to handle
- Error handling: Catch and re-throw with descriptive messages

**2. pollForToken(clientId, clientSecret, deviceCode, interval, expiresAt)**
- Import: SSOOIDCClient, CreateTokenCommand
- Poll CreateToken every `interval` seconds until success or `expiresAt`
- Handle: AuthorizationPendingException (continue polling), SlowDownException (increase interval by 5s)
- Return: { accessToken, expiresAt: Date, refreshToken? }
- Error handling: Throw on timeout, other errors

**3. listAccountsAndRoles(accessToken, ssoRegion)**
- Import: SSOClient, paginateListAccounts, ListAccountRolesCommand
- Use paginateListAccounts for all accounts
- For each account, call ListAccountRolesCommand to get roles
- Return: Array<{ accountId, accountName, emailAddress?, roles: Array<{ roleName, accountId }> }>
- Error handling: Handle pagination errors, empty role lists gracefully

**4. cacheSsoToken(startUrl, region, accessToken, expiresAt) + loadCachedSsoToken(startUrl)**
- Import: fs/promises, path, os, crypto
- Cache directory: ~/.aws/sso/cache/
- Cache key: SHA1 hash of startUrl (same as AWS CLI algorithm)
- Cache file format: JSON with { accessToken, expiresAt: ISO 8601, region, startUrl }
- loadCachedSsoToken: Return token if not expired, null if expired/missing
- Error handling: Return null on read errors, log warnings

**TypeScript interfaces:**
```typescript
export interface DeviceAuthResult {
  deviceCode: string
  verificationUriComplete: string
  expiresIn: number
  interval: number
  clientId: string
  clientSecret: string
}

export interface TokenResult {
  accessToken: string
  expiresAt: Date
  refreshToken?: string
}

export interface AccountWithRoles {
  accountId: string
  accountName: string
  emailAddress?: string
  roles: Array<{
    roleName: string
    accountId: string
  }>
}
```

**Reference research code examples** from 05-RESEARCH.md sections:
- "Complete Device Authorization Flow" (lines 258-331)
- "List Accounts and Roles with Pagination" (lines 334-383)
- "Cache SSO Token to Disk" (lines 386-453)

**Critical: Respect polling interval from device auth response** - Default 5 seconds, handle SlowDownException by increasing interval (Pitfall #5).

**Critical: Separate SSO region from Bedrock region** - ssoRegion for SSO clients, bedrockRegion stored separately for Bedrock API (Pitfall #2).
  </action>
  <verify>
1. Run: `bun run build` and verify TypeScript compilation succeeds
2. Check file exports: performDeviceAuthorization, pollForToken, listAccountsAndRoles, cacheSsoToken, loadCachedSsoToken
3. Verify imports match research: @aws-sdk/client-sso-oidc, @aws-sdk/client-sso
  </verify>
  <done>
AWS SSO client implemented. File exports all required functions with TypeScript interfaces. Device authorization flow follows OAuth2 device grant pattern. Account listing uses pagination. Token caching compatible with AWS CLI format in ~/.aws/sso/cache/. All functions have error handling and respect AWS SDK best practices.
  </done>
</task>

</tasks>

<verification>
1. Database has AWS SSO fields: `sqlite3 ~/Library/Application\ Support/Agents\ Dev/data/agents.db "PRAGMA table_info(claude_code_settings);"` shows all 5 new columns
2. AWS SDK packages installed: `bun pm ls @aws-sdk/client-sso-oidc @aws-sdk/client-sso` shows 3.x versions
3. AWS SSO client file exists and compiles: `bun run build` succeeds
4. Client exports match requirements: Check src/main/lib/aws-sso-client.ts exports match task 3 list
</verification>

<success_criteria>
- [x] claudeCodeSettings table has 5 new AWS SSO fields (awsSsoStartUrl, awsSsoRegion, awsSsoAccountId, awsSsoRoleName, awsSsoSessionName)
- [x] Migration generated and applied successfully
- [x] AWS SDK v3 packages installed (@aws-sdk/client-sso-oidc, @aws-sdk/client-sso, @aws-sdk/client-bedrock-runtime, @aws-sdk/credential-providers)
- [x] src/main/lib/aws-sso-client.ts exists with 4 exported functions
- [x] Device authorization flow implemented following OAuth2 device grant pattern
- [x] Account/role listing implemented with pagination support
- [x] Token caching implemented with AWS CLI compatibility
- [x] TypeScript compilation succeeds
- [x] Error handling implemented for all AWS SDK calls
</success_criteria>

<output>
After completion, create `.planning/phases/05-aws-bedrock-authentication/05-01-SUMMARY.md` following the summary template with:
- Frontmatter: phase, plan, subsystem (authentication), tags, requires/provides/affects, tech-stack, key-files, key-decisions, patterns-established
- Brief description of what was built
- Key technical decisions made
- Any deviations from plan
</output>
