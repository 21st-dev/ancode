---
phase: 05-aws-bedrock-authentication
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx
autonomous: true

must_haves:
  truths:
    - "User can view current AWS SSO configuration in settings"
    - "User can change SSO portal URL and region"
    - "User can re-authenticate with AWS SSO"
    - "User can switch AWS account/role selection"
    - "Settings save updates database and applies immediately"
  artifacts:
    - path: "src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx"
      provides: "AWS SSO configuration in settings"
      contains: "authMode === \"aws\""
      min_lines: 600
  key_links:
    - from: "src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx"
      to: "trpc.claudeSettings.getSettings"
      via: "useQuery hook to load current config"
      pattern: "trpc\\.claudeSettings\\.getSettings"
    - from: "src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx"
      to: "trpc.awsSso.startDeviceAuth"
      via: "useMutation hook for re-auth"
      pattern: "trpc\\.awsSso\\.startDeviceAuth"
    - from: "src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx"
      to: "trpc.awsSso.saveProfile"
      via: "useMutation hook to persist changes"
      pattern: "trpc\\.awsSso\\.saveProfile"
---

<objective>
Add AWS SSO configuration to the Claude Code settings tab, allowing users to view, modify, and re-authenticate their AWS SSO credentials after initial onboarding.

Purpose: Enable users to manage their AWS SSO configuration post-onboarding. Users may need to switch AWS accounts, change regions, or re-authenticate when tokens expire. This provides ongoing AWS SSO credential management in the settings UI.

Output: Updated Claude Code settings tab with AWS SSO configuration section, including current profile display, re-authentication flow, account/role switching, and settings persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-aws-bedrock-authentication/05-RESEARCH.md
@.planning/phases/05-aws-bedrock-authentication/05-01-SUMMARY.md
@.planning/phases/05-aws-bedrock-authentication/05-02-SUMMARY.md

# Current settings implementation
@src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx

# UI components
@src/renderer/components/ui/input.tsx
@src/renderer/components/ui/button.tsx
@src/renderer/components/ui/label.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AWS SSO configuration to settings</name>
  <files>
    src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx
  </files>
  <action>
Update agents-claude-code-tab.tsx to add AWS SSO configuration section:

**1. Load current AWS SSO settings (already has getSettings query, extract AWS fields):**

Check if settings query already exists. If yes, extract AWS SSO fields from result:
```typescript
const settings = settingsQuery.data
const currentAuthMode = settings?.authMode || "oauth"
const currentSsoStartUrl = settings?.awsSsoStartUrl || ""
const currentSsoRegion = settings?.awsSsoRegion || "us-east-1"
const currentAccountId = settings?.awsSsoAccountId || ""
const currentRoleName = settings?.awsSsoRoleName || ""
```

**2. State management for AWS SSO section (add local state):**
```typescript
const [showReauthFlow, setShowReauthFlow] = useState(false)
const [deviceAuthData, setDeviceAuthData] = useState<{
  deviceCode: string
  verificationUriComplete: string
  interval: number
  expiresAt: Date
  sessionId: string
} | null>(null)
const [accessToken, setAccessToken] = useState<string | null>(null)
const [accounts, setAccounts] = useState<Array<{
  accountId: string
  accountName: string
  roles: Array<{ roleName: string; accountId: string }>
}>>([])
```

**3. tRPC mutations (add if not already present):**
```typescript
const startDeviceAuthMutation = trpc.awsSso.startDeviceAuth.useMutation()
const listAccountsMutation = trpc.awsSso.listAccounts.useMutation()
const saveProfileMutation = trpc.awsSso.saveProfile.useMutation()
```

**4. Device auth polling (same pattern as onboarding):**
```typescript
const pollDeviceAuthQuery = trpc.awsSso.pollDeviceAuth.useQuery(
  {
    sessionId: deviceAuthData?.sessionId || "",
    deviceCode: deviceAuthData?.deviceCode || "",
    interval: deviceAuthData?.interval || 5,
    expiresAt: deviceAuthData?.expiresAt.toISOString() || ""
  },
  {
    enabled: showReauthFlow && deviceAuthData !== null && accessToken === null,
    refetchInterval: (deviceAuthData?.interval || 5) * 1000,
  }
)
```

**5. UI rendering (add AWS SSO section in settings form):**

Find the section where authMode === "aws" is rendered (or add it after existing auth sections). Add:

```tsx
{currentAuthMode === "aws" && (
  <div className="space-y-4 rounded-lg border p-4">
    <h3 className="font-semibold">AWS SSO Configuration</h3>

    {/* Current configuration display */}
    {!showReauthFlow && (
      <div className="space-y-2">
        <div>
          <Label>SSO Portal URL</Label>
          <p className="text-sm text-muted-foreground">{currentSsoStartUrl || "Not configured"}</p>
        </div>
        <div>
          <Label>SSO Region</Label>
          <p className="text-sm text-muted-foreground">{currentSsoRegion}</p>
        </div>
        <div>
          <Label>AWS Account</Label>
          <p className="text-sm text-muted-foreground">{currentAccountId || "Not selected"}</p>
        </div>
        <div>
          <Label>IAM Role</Label>
          <p className="text-sm text-muted-foreground">{currentRoleName || "Not selected"}</p>
        </div>

        <Button
          variant="outline"
          onClick={() => setShowReauthFlow(true)}
        >
          Re-authenticate / Change Profile
        </Button>
      </div>
    )}

    {/* Re-authentication flow (similar to onboarding) */}
    {showReauthFlow && (
      <div className="space-y-4">
        <div>
          <Label htmlFor="settings-sso-start-url">SSO Portal URL</Label>
          <Input
            id="settings-sso-start-url"
            type="url"
            defaultValue={currentSsoStartUrl}
            placeholder="https://d-XXXXXXXXXX.awsapps.com/start"
          />
        </div>

        <div>
          <Label htmlFor="settings-sso-region">SSO Region</Label>
          <Input
            id="settings-sso-region"
            defaultValue={currentSsoRegion}
            placeholder="us-east-1"
          />
        </div>

        {!deviceAuthData && !accessToken && (
          <div className="flex gap-2">
            <Button
              onClick={async () => {
                const startUrlInput = document.getElementById("settings-sso-start-url") as HTMLInputElement
                const regionInput = document.getElementById("settings-sso-region") as HTMLInputElement

                const result = await startDeviceAuthMutation.mutateAsync({
                  ssoStartUrl: startUrlInput.value,
                  ssoRegion: regionInput.value
                })
                setDeviceAuthData({
                  ...result,
                  expiresAt: new Date(Date.now() + result.expiresIn * 1000),
                  sessionId: crypto.randomUUID()
                })
                window.open(result.verificationUriComplete, "_blank")
              }}
              disabled={startDeviceAuthMutation.isPending}
            >
              {startDeviceAuthMutation.isPending ? "Starting..." : "Authenticate"}
            </Button>
            <Button
              variant="ghost"
              onClick={() => {
                setShowReauthFlow(false)
                setDeviceAuthData(null)
                setAccessToken(null)
                setAccounts([])
              }}
            >
              Cancel
            </Button>
          </div>
        )}

        {deviceAuthData && !accessToken && (
          <div className="rounded-md border p-4">
            <p className="text-sm">Complete authentication in your browser:</p>
            <a
              href={deviceAuthData.verificationUriComplete}
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-500 underline"
            >
              {deviceAuthData.verificationUriComplete}
            </a>
            <p className="mt-2 text-xs text-muted-foreground">
              {pollDeviceAuthQuery.isFetching ? "Waiting for authentication..." : "Polling..."}
            </p>
          </div>
        )}

        {accessToken && accounts.length > 0 && (
          <div className="space-y-3">
            {/* Account/role selection (same as onboarding) */}
            {/* ... (account select dropdown) ... */}
            {/* ... (role select dropdown) ... */}
            <Button
              onClick={async () => {
                const startUrlInput = document.getElementById("settings-sso-start-url") as HTMLInputElement
                const regionInput = document.getElementById("settings-sso-region") as HTMLInputElement
                const accountSelect = document.getElementById("account-select") as HTMLSelectElement
                const roleSelect = document.getElementById("role-select") as HTMLSelectElement

                await saveProfileMutation.mutateAsync({
                  ssoStartUrl: startUrlInput.value,
                  ssoRegion: regionInput.value,
                  accountId: accountSelect.value,
                  roleName: roleSelect.value
                })

                // Reset flow and refetch settings
                setShowReauthFlow(false)
                setDeviceAuthData(null)
                setAccessToken(null)
                setAccounts([])
                settingsQuery.refetch()
              }}
              disabled={saveProfileMutation.isPending}
            >
              {saveProfileMutation.isPending ? "Saving..." : "Save Profile"}
            </Button>
          </div>
        )}
      </div>
    )}
  </div>
)}
```

**6. Handle successful auth (same useEffect as onboarding):**
```typescript
useEffect(() => {
  if (showReauthFlow && pollDeviceAuthQuery.data?.success && pollDeviceAuthQuery.data.accessToken) {
    const regionInput = document.getElementById("settings-sso-region") as HTMLInputElement
    setAccessToken(pollDeviceAuthQuery.data.accessToken)
    listAccountsMutation.mutate(
      { accessToken: pollDeviceAuthQuery.data.accessToken, ssoRegion: regionInput.value },
      {
        onSuccess: (data) => {
          setAccounts(data)
        }
      }
    )
  }
}, [showReauthFlow, pollDeviceAuthQuery.data])
```

**Pattern from current code:** Follow existing settings structure - display current values when not editing, show form when editing/re-authenticating, save and refetch on success.

**Why collapsible re-auth flow:** Keeps settings UI clean by default (just shows current config), expands to full flow only when user clicks "Re-authenticate / Change Profile".

**Critical: Refetch settings after save** - Ensures UI displays updated values immediately (settingsQuery.refetch()).
  </action>
  <verify>
1. Run: `bun run dev` and navigate to Settings > Claude Code
2. Verify AWS SSO section appears when auth mode is "aws"
3. Check current configuration is displayed (portal URL, region, account, role)
4. Verify "Re-authenticate / Change Profile" button is present
5. Click button and verify re-auth flow appears
6. Check TypeScript compilation: `bun run build`
  </verify>
  <done>
AWS SSO configuration added to settings. Current profile displays portal URL, region, account ID, and role name. Re-authenticate button triggers device auth flow. Account/role selection dropdowns allow profile switching. Save updates database and refetches settings. Cancel button resets flow. All state managed with React hooks. TypeScript compilation succeeds.
  </done>
</task>

</tasks>

<verification>
1. File updated: `git diff src/renderer/features/agents/components/settings-tabs/agents-claude-code-tab.tsx` shows AWS SSO additions
2. TypeScript compilation: `bun run build` succeeds
3. AWS SSO state: grep "showReauthFlow\|deviceAuthData" in file
4. Current config display: grep "currentSsoStartUrl\|currentAccountId" in file
5. Re-auth flow: grep "showReauthFlow.*true" in file
6. Save and refetch: grep "settingsQuery\\.refetch" in file
</verification>

<success_criteria>
- [x] Current AWS SSO configuration displayed (portal URL, region, account, role)
- [x] Re-authenticate button triggers device auth flow
- [x] Device auth flow state managed (deviceAuthData, accessToken, accounts)
- [x] Polling implemented with useQuery and refetchInterval
- [x] Account/role selection dropdowns render after auth
- [x] Save Profile button updates database via saveProfile mutation
- [x] Settings query refetches after save to show updated values
- [x] Cancel button resets flow state
- [x] TypeScript compilation succeeds
- [x] Browser window opens to verification URL on auth start
</success_criteria>

<output>
After completion, create `.planning/phases/05-aws-bedrock-authentication/05-04-SUMMARY.md` following the summary template with:
- Frontmatter: requires 05-02, provides settings AWS SSO management, affects post-onboarding configuration
- Description of settings UI added
- State management for collapsible re-auth flow
- Any UX considerations for profile switching
</output>
