---
phase: 05-aws-bedrock-authentication
plan: 05
type: execute
wave: 4
depends_on: ["05-02"]
files_modified:
  - src/main/lib/claude/env.ts
  - src/main/lib/trpc/routers/claude.ts
autonomous: false

must_haves:
  truths:
    - "Claude SDK receives AWS_PROFILE environment variable when authMode is aws"
    - "Claude SDK receives CLAUDE_CODE_USE_BEDROCK=1 when authMode is aws"
    - "Claude SDK receives AWS_REGION set to bedrockRegion when authMode is aws"
    - "AWS credentials are resolved via AWS SDK credential chain"
    - "Claude agent sessions work with Bedrock API using AWS SSO credentials"
    - "User can verify end-to-end AWS SSO → Bedrock flow"
  artifacts:
    - path: "src/main/lib/claude/env.ts"
      provides: "AWS SSO credential injection for Claude SDK"
      contains: "CLAUDE_CODE_USE_BEDROCK"
      min_lines: 260
    - path: "src/main/lib/trpc/routers/claude.ts"
      provides: "Claude SDK execution with AWS SSO environment"
      contains: "authMode === \"aws\""
  key_links:
    - from: "src/main/lib/claude/env.ts"
      to: "claudeCodeSettings.authMode"
      via: "read auth mode from database"
      pattern: "settings\\.authMode.*===.*[\"']aws[\"']"
    - from: "src/main/lib/claude/env.ts"
      to: "CLAUDE_CODE_USE_BEDROCK"
      via: "set environment variable"
      pattern: "env\\.CLAUDE_CODE_USE_BEDROCK.*=.*[\"']1[\"']"
    - from: "src/main/lib/trpc/routers/claude.ts"
      to: "buildClaudeEnv"
      via: "call with customEnv for AWS credentials"
      pattern: "buildClaudeEnv\\(\\{.*customEnv"
---

<objective>
Integrate AWS SSO credentials into Claude SDK environment, enabling Bedrock API access for Claude agent sessions. Update buildClaudeEnv() to inject AWS profile configuration when authMode is "aws".

Purpose: Complete the AWS SSO authentication flow by configuring Claude SDK to use Bedrock API with AWS SSO credentials. This enables the actual Claude agent execution to authenticate with AWS Bedrock instead of Anthropic API when user has selected AWS auth mode.

Output: Updated buildClaudeEnv() function that reads AWS SSO profile from database and injects AWS environment variables (AWS_PROFILE, AWS_REGION, CLAUDE_CODE_USE_BEDROCK) for Claude SDK. Includes end-to-end verification checkpoint to confirm Bedrock authentication works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-aws-bedrock-authentication/05-RESEARCH.md
@.planning/phases/05-aws-bedrock-authentication/05-01-SUMMARY.md
@.planning/phases/05-aws-bedrock-authentication/05-02-SUMMARY.md

# Claude environment builder
@src/main/lib/claude/env.ts

# Claude SDK execution
@src/main/lib/trpc/routers/claude.ts

# Database schema
@src/main/lib/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update buildClaudeEnv for AWS SSO credentials</name>
  <files>
    src/main/lib/claude/env.ts
  </files>
  <action>
Update buildClaudeEnv() function to inject AWS SSO credentials when authMode is "aws":

**1. Import database access (add to existing imports):**
```typescript
import { getDatabase, claudeCodeSettings } from "../db"
import { eq } from "drizzle-orm"
```

**2. Add AWS credential loading to buildClaudeEnv() function:**

After line ~218 (after custom overrides section), add:

```typescript
// 6. Add AWS SSO configuration for Bedrock
const db = getDatabase()
const settings = db
  .select()
  .from(claudeCodeSettings)
  .where(eq(claudeCodeSettings.id, "default"))
  .get()

if (settings?.authMode === "aws") {
  console.log("[claude-env] Configuring AWS SSO credentials for Bedrock")

  // Enable Bedrock mode
  env.CLAUDE_CODE_USE_BEDROCK = "1"

  // Set AWS region for Bedrock API
  env.AWS_REGION = settings.bedrockRegion || "us-east-1"

  // Generate AWS profile name from account/role
  if (settings.awsSsoAccountId && settings.awsSsoRoleName) {
    // Follow AWS CLI naming convention: SSO-{RoleName}-{AccountId}
    const profileName = `SSO-${settings.awsSsoRoleName}-${settings.awsSsoAccountId}`
    env.AWS_PROFILE = profileName

    console.log(`[claude-env] AWS_PROFILE: ${profileName}`)
    console.log(`[claude-env] AWS_REGION: ${env.AWS_REGION}`)

    // Generate AWS config file if it doesn't exist (for first-time use)
    generateAwsConfigIfNeeded(
      profileName,
      settings.awsSsoStartUrl || "",
      settings.awsSsoRegion || "us-east-1",
      settings.awsSsoAccountId,
      settings.awsSsoRoleName
    )
  } else {
    console.warn("[claude-env] AWS SSO configured but account/role not selected")
  }
}
```

**3. Add helper function to generate AWS config (after buildClaudeEnv function):**

```typescript
/**
 * Generate AWS config file entry for SSO profile if not exists
 * This enables AWS SDK credential resolution via fromSSO()
 */
function generateAwsConfigIfNeeded(
  profileName: string,
  ssoStartUrl: string,
  ssoRegion: string,
  accountId: string,
  roleName: string
): void {
  const configPath = path.join(os.homedir(), ".aws", "config")

  try {
    // Create .aws directory if not exists
    const awsDir = path.dirname(configPath)
    if (!fs.existsSync(awsDir)) {
      fs.mkdirSync(awsDir, { recursive: true })
    }

    // Check if profile already exists
    let configContent = ""
    if (fs.existsSync(configPath)) {
      configContent = fs.readFileSync(configPath, "utf-8")
      if (configContent.includes(`[profile ${profileName}]`)) {
        console.log(`[claude-env] AWS config profile ${profileName} already exists`)
        return
      }
    }

    // Append profile configuration
    const profileConfig = `
[profile ${profileName}]
sso_start_url = ${ssoStartUrl}
sso_region = ${ssoRegion}
sso_account_id = ${accountId}
sso_role_name = ${roleName}
region = ${ssoRegion}
output = json
`

    fs.appendFileSync(configPath, profileConfig)
    console.log(`[claude-env] Generated AWS config profile: ${profileName}`)
  } catch (error) {
    console.error("[claude-env] Failed to generate AWS config:", error)
    // Non-fatal - AWS SDK can still work with SSO token cache
  }
}
```

**Pattern from research:** AWS SDK resolves credentials via environment variables → AWS config file → SSO token cache. By setting AWS_PROFILE, we tell AWS SDK which profile to use. The SDK automatically finds SSO tokens in ~/.aws/sso/cache/.

**Why generate AWS config:** AWS SDK needs profile definition in ~/.aws/config to know sso_start_url, sso_region, account_id, role_name. Without this, credential resolution fails even with valid SSO tokens.

**Why non-fatal config generation:** If config generation fails (permissions, etc.), AWS SDK can still work if user has manually configured their ~/.aws/config. We log the error but don't block execution.

**Critical: Separate AWS_REGION from ssoRegion** - AWS_REGION is for Bedrock API calls (where models are hosted). ssoRegion is for IAM Identity Center (where SSO portal is hosted). These are often different regions.
  </action>
  <verify>
1. Run: `bun run build` and verify TypeScript compilation succeeds
2. Check buildClaudeEnv imports: grep "getDatabase\|claudeCodeSettings" src/main/lib/claude/env.ts
3. Check AWS mode logic: grep "authMode === \"aws\"" src/main/lib/claude/env.ts
4. Check environment variables set: grep "CLAUDE_CODE_USE_BEDROCK\|AWS_PROFILE\|AWS_REGION" src/main/lib/claude/env.ts
5. Check helper function: grep "generateAwsConfigIfNeeded" src/main/lib/claude/env.ts
  </verify>
  <done>
buildClaudeEnv() updated to read AWS SSO settings from database. When authMode is "aws", function sets CLAUDE_CODE_USE_BEDROCK=1, AWS_REGION, and AWS_PROFILE environment variables. Helper function generates ~/.aws/config profile entry if needed. AWS SDK credential chain can now resolve SSO credentials for Bedrock API. TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Claude SDK calls buildClaudeEnv correctly</name>
  <files>
    src/main/lib/trpc/routers/claude.ts
  </files>
  <action>
Verify that Claude SDK execution in claude.ts router properly uses buildClaudeEnv():

**1. Check query/execute procedures:**

Find where Claude SDK is invoked (likely in `query` or `execute` procedures). Verify that `buildClaudeEnv()` is called to construct the environment object.

**2. If buildClaudeEnv is already called:**
- No changes needed - it already includes AWS SSO logic from Task 1

**3. If buildClaudeEnv is NOT called:**
- Update the procedure to call `buildClaudeEnv({ customEnv, ghToken })` before SDK invocation
- Pass the result as `env` option to Claude SDK

**Example pattern (if needed):**
```typescript
// Before Claude SDK invocation
const env = buildClaudeEnv({
  ghToken: ghToken,
  customEnv: customEnvVars // from settings
})

// Pass to SDK
for await (const message of query({
  prompt: userPrompt,
  options: {
    env,
    cwd: projectPath,
    // ... other options
  }
})) {
  // ... handle messages
}
```

**Pattern from current code:** The claude.ts router should already be using buildClaudeEnv for environment construction. This task is verification to ensure AWS SSO environment variables flow through correctly.

**If no changes needed:** Document in verification that claude.ts already calls buildClaudeEnv(), so AWS SSO environment variables are automatically included.
  </action>
  <verify>
1. Check claude.ts calls buildClaudeEnv: grep "buildClaudeEnv" src/main/lib/trpc/routers/claude.ts
2. Verify env passed to Claude SDK: grep "env:" src/main/lib/trpc/routers/claude.ts (should be within SDK call)
3. Run: `bun run build` and verify compilation succeeds
  </verify>
  <done>
Verified that Claude SDK execution uses buildClaudeEnv() for environment construction. AWS SSO environment variables (CLAUDE_CODE_USE_BEDROCK, AWS_PROFILE, AWS_REGION) automatically flow through to Claude SDK when authMode is "aws". No changes needed if buildClaudeEnv already called, or updated to call it if not. TypeScript compilation succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AWS SSO authentication flow integrated with Claude SDK for Bedrock API access. This includes:
- Database migration with AWS SSO fields
- AWS SSO client (device authorization, account listing, token caching)
- tRPC backend procedures (startDeviceAuth, pollDeviceAuth, listAccounts, saveProfile)
- Onboarding UI with AWS SSO flow
- Settings UI with profile management
- Claude environment builder with AWS credential injection
  </what-built>

  <how-to-verify>
**Test 1: Complete onboarding with AWS SSO**
1. Delete app data to simulate first install: `rm -rf ~/Library/Application\ Support/Agents\ Dev/`
2. Run app: `bun run dev`
3. Navigate to onboarding page
4. Select "AWS SSO" auth mode
5. Enter SSO portal URL: https://d-9067694978.awsapps.com/start (or your org's SSO URL)
6. Enter SSO region: us-east-1 (or your IAM Identity Center region)
7. Click "Authenticate with AWS SSO"
8. Verify browser opens to verification URL
9. Complete authentication in browser (sign in with AWS SSO credentials)
10. Wait for app to detect auth completion (should show "Authentication successful")
11. Verify account/role dropdown populates with your AWS accounts
12. Select an account and role
13. Click "Complete Setup"
14. Verify onboarding completes and app navigates to main UI

**Expected:** Onboarding completes successfully. Settings show AWS auth mode with selected account/role.

**Test 2: Verify settings display and re-authentication**
1. Navigate to Settings > Claude Code
2. Verify current AWS SSO configuration is displayed:
   - SSO Portal URL
   - SSO Region
   - AWS Account ID
   - IAM Role Name
3. Click "Re-authenticate / Change Profile"
4. Verify re-auth flow appears (same as onboarding)
5. Complete device auth flow again
6. Select different account/role (if available)
7. Click "Save Profile"
8. Verify settings update and display new values

**Expected:** Settings display current config. Re-auth flow works. Profile updates persist.

**Test 3: Verify Claude SDK uses Bedrock credentials**
1. Create a new project and chat
2. Send a message to Claude agent
3. Check Electron main process logs for:
   - `[claude-env] Configuring AWS SSO credentials for Bedrock`
   - `[claude-env] AWS_PROFILE: SSO-{RoleName}-{AccountId}`
   - `[claude-env] AWS_REGION: {your-bedrock-region}`
4. Verify Claude responds (confirms Bedrock API call succeeded)
5. If Claude returns auth error: Check ~/.aws/sso/cache/ has valid token (run `aws sso login --profile {profile-name}` if needed)

**Expected:** Claude agent executes successfully using Bedrock API. Logs show AWS environment variables set correctly.

**Test 4: Verify AWS config file generation**
1. Check `~/.aws/config` file exists
2. Verify it contains profile entry for your selected account/role:
   ```
   [profile SSO-{RoleName}-{AccountId}]
   sso_start_url = https://d-9067694978.awsapps.com/start
   sso_region = us-east-1
   sso_account_id = {your-account-id}
   sso_role_name = {your-role-name}
   region = us-east-1
   ```

**Expected:** AWS config file contains generated profile. Profile matches settings.

**Test 5: Token expiration handling**
1. Wait for SSO token to expire (typically 1-8 hours, or manually delete token from ~/.aws/sso/cache/)
2. Try to send Claude message
3. If auth error occurs, verify user can re-authenticate via Settings
4. Complete re-auth flow
5. Verify Claude messages work again

**Expected:** Token expiration is recoverable via re-authentication in settings.

**Edge cases to check:**
- [ ] Invalid SSO portal URL shows error
- [ ] Device auth timeout (10 min) shows error
- [ ] Switching auth modes (oauth → aws → oauth) works
- [ ] Multiple account/role combinations can be tested
- [ ] Browser verification URL opens correctly on macOS
  </how-to-verify>

  <resume-signal>
Type "verified" when all tests pass, or describe any issues found.

If issues found, describe:
- Which test failed
- Error messages seen
- Expected vs actual behavior
- Screenshots if relevant

If tests pass, confirm:
- "All 5 tests passed"
- "AWS SSO authentication flow works end-to-end"
- "Claude SDK successfully uses Bedrock API with SSO credentials"
  </resume-signal>
</task>

</tasks>

<verification>
1. buildClaudeEnv updated: `git diff src/main/lib/claude/env.ts` shows AWS SSO logic
2. Database access added: grep "getDatabase\|claudeCodeSettings" in env.ts
3. AWS environment variables: grep "CLAUDE_CODE_USE_BEDROCK\|AWS_PROFILE" in env.ts
4. Helper function: grep "generateAwsConfigIfNeeded" in env.ts
5. Claude SDK integration: grep "buildClaudeEnv" in claude.ts
6. TypeScript compilation: `bun run build` succeeds
7. End-to-end verification: Human confirms all 5 test scenarios pass
</verification>

<success_criteria>
- [x] buildClaudeEnv() reads AWS SSO settings from database
- [x] CLAUDE_CODE_USE_BEDROCK=1 set when authMode is "aws"
- [x] AWS_PROFILE set to SSO-{RoleName}-{AccountId}
- [x] AWS_REGION set to bedrockRegion from settings
- [x] generateAwsConfigIfNeeded() creates ~/.aws/config profile entry
- [x] Claude SDK receives AWS environment variables
- [x] Claude agent sessions work with Bedrock API
- [x] Onboarding flow completes successfully with AWS SSO
- [x] Settings display current AWS SSO configuration
- [x] Re-authentication flow works in settings
- [x] Profile switching updates and persists
- [x] TypeScript compilation succeeds
- [x] End-to-end verification passes all test scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/05-aws-bedrock-authentication/05-05-SUMMARY.md` following the summary template with:
- Frontmatter: requires 05-02, provides complete AWS SSO + Bedrock integration, affects all Claude SDK executions
- Description of Claude environment integration
- AWS config generation approach
- Verification results (test scenarios that passed)
- Any edge cases or known limitations
</output>
