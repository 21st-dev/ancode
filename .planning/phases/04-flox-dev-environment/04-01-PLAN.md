---
phase: 04-flox-dev-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .flox/env/manifest.toml
  - CLAUDE.md
  - README.md
autonomous: false

must_haves:
  truths:
    - "Developer can run 'flox activate' in project root successfully"
    - "Activated environment provides correct versions of bun, electron"
    - "TypeScript language server is available via devyard inheritance"
    - "Electron binary is not downloaded twice (npm skip works)"
    - "Existing 'bun run dev' command works within activated environment"
    - "Documentation clearly explains when to use Flox vs package.json"
  artifacts:
    - path: ".flox/env/manifest.toml"
      provides: "Flox environment specification with devyard include"
      contains: "[include], [install], [vars], [profile], [options]"
    - path: ".flox/env/manifest.lock"
      provides: "Locked dependency versions"
      min_lines: 1
    - path: "CLAUDE.md"
      provides: "Updated with Flox workflow"
      contains: "flox activate"
    - path: "README.md"
      provides: "Updated installation prerequisites"
      contains: "Flox"
  key_links:
    - from: ".flox/env/manifest.toml"
      to: "../devyard/.flox/env/manifest.toml"
      via: "[include] directive"
      pattern: "\\[include\\]"
    - from: ".flox/env/manifest.toml"
      to: "package.json electron version"
      via: "version constraint match"
      pattern: "electron.*~33\\.0"
    - from: ".flox/env/manifest.toml"
      to: "bun runtime"
      via: "ELECTRON_SKIP_BINARY_DOWNLOAD prevents duplicate"
      pattern: "ELECTRON_SKIP_BINARY_DOWNLOAD"
    - from: "CLAUDE.md"
      to: ".flox/env/manifest.toml"
      via: "documentation references actual config"
      pattern: "flox activate"
---

<objective>
Establish reproducible development environment using Flox with inheritance from devyard to manage system-level dependencies. The 1code environment inherits TypeScript tooling from devyard and adds app-specific dependencies (bun, electron).

Purpose: Eliminate "works on my machine" issues by declaring all system dependencies in a version-controlled manifest, following the pattern successfully used in the avatar reference project.

Output: Flox environment with manifest.toml using [include] directive, updated documentation explaining Flox workflow and inheritance pattern, and verified compatibility with existing dev commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flox-dev-environment/04-RESEARCH.md

# Reference pattern (avatar uses devyard include)
@/Users/jdeland/dev/vidyard/avatar/.flox/env/manifest.toml

# Inherited environment
@/Users/jdeland/dev/vidyard/devyard/.flox/env/manifest.toml

# Current project files
@package.json
@CLAUDE.md
@README.md
</context>

<tasks>

<task type="auto">
  <name>Initialize Flox Environment with Devyard Inheritance</name>
  <files>
    .flox/env/manifest.toml
    .flox/env/manifest.lock
  </files>
  <action>
Initialize Flox environment and create manifest.toml following the avatar reference pattern with devyard inheritance.

**Steps:**

1. **Initialize Flox environment:**
```bash
cd /Users/jdeland/1code
flox init --name 1code
```

2. **Install 1code-specific dependencies:**
```bash
# JavaScript runtime and package manager
flox install bun@~1.2

# Electron for desktop app (matches package.json 33.4.5)
flox install electron@~33.0
```

3. **Configure manifest using flox edit:**
```bash
flox edit
```

Add the following structure to match the avatar pattern:

```toml
[include]
environments = [
  { dir = "../devyard" },
]

[install]
# Keep the auto-generated bun and electron entries
# Do NOT add typescript-language-server - inherited from devyard

[vars]
# Indicate Flox environment is active
FLOX_ENVIRONMENT = "1"

[profile]
common = '''
  # Skip electron binary download from npm (prevents duplication)
  export ELECTRON_SKIP_BINARY_DOWNLOAD=1

  # Helpful activation message
  echo "✓ 1Code development environment activated"
  echo "  Bun: $(bun --version)"
  echo "  Electron: $(electron --version)"
  echo "  TypeScript LSP: $(which typescript-language-server) (via devyard)"
'''

[options]
# Support both macOS and Linux, both architectures
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-darwin", "x86_64-linux"]
```

4. **Verify installation and inheritance:**
```bash
# Verify 1code-specific tools
flox activate -- which bun
flox activate -- which electron

# Verify inherited tools from devyard
flox activate -- which typescript-language-server
flox activate -- which nodejs
```

**Important:**
- The `[include]` section MUST come first (before `[install]`) to inherit from devyard
- Use separate pkg-groups for bun and electron to avoid version conflicts (flox should set this automatically)
- Keep bun version as ~1.2 (loose constraint, matches avatar pattern)
- Keep electron version as ~33.0 (matches package.json 33.4.5 - major.minor match)
- Do NOT add typescript-language-server - it's inherited from devyard (line 61-62 in devyard manifest)
- Do NOT add npm packages to manifest.toml - those stay in package.json
- The ELECTRON_SKIP_BINARY_DOWNLOAD=1 prevents duplicate electron binary in node_modules/electron/
- The relative path `../devyard` assumes standard Vidyard monorepo structure where 1code and devyard are siblings

**Why these versions:**
- bun ~1.2: Current stable, needed for this Electron app's package manager
- electron ~33.0: Matches package.json devDependencies electron 33.4.5
- typescript-language-server: Inherited from devyard (no explicit declaration needed)
  </action>
  <verify>
1. Check manifest exists: `ls -la .flox/env/manifest.toml`
2. Check manifest has include directive: `grep -A 2 "\[include\]" .flox/env/manifest.toml`
3. Check lockfile generated: `ls -la .flox/env/manifest.lock`
4. Verify activation works: `flox activate`
5. Verify 1code tools: `flox activate -- bun --version`
6. Verify inherited tools: `flox activate -- typescript-language-server --version`
7. Verify ELECTRON_SKIP_BINARY_DOWNLOAD set: `flox activate -- echo $ELECTRON_SKIP_BINARY_DOWNLOAD`
  </verify>
  <done>
- .flox/env/manifest.toml exists with [include], [install], [vars], [profile], [options] sections
- [include] section references ../devyard
- .flox/env/manifest.lock exists (auto-generated)
- `flox activate` completes successfully with activation message
- bun and electron are available (1code-specific)
- typescript-language-server is available (inherited from devyard)
- ELECTRON_SKIP_BINARY_DOWNLOAD=1 is set in activated shell
  </done>
</task>

<task type="auto">
  <name>Update Documentation with Flox Workflow and Inheritance</name>
  <files>
    CLAUDE.md
    README.md
  </files>
  <action>
Update CLAUDE.md and README.md to document the Flox workflow with devyard inheritance pattern.

**CLAUDE.md updates:**

Add a new section after the "Commands" section (around line 30):

```markdown
## Development Environment

This project uses **Flox** for reproducible development environments. The 1code environment inherits from the devyard environment (TypeScript tooling, Node.js, Python, etc.) and adds app-specific dependencies (bun, electron).

### Inheritance Pattern

```
devyard/.flox/env/manifest.toml
  ├─ TypeScript language server
  ├─ Node.js, Python, etc.
  └─ Claude Code LSP integration

1code/.flox/env/manifest.toml
  ├─ [include] → ../devyard
  ├─ bun (package manager)
  └─ electron (desktop framework)
```

This follows the same pattern as the avatar project. TypeScript LSP is available via inheritance.

### First-time Setup

```bash
# Install Flox (if not already installed)
curl -fsSL https://install.flox.dev | bash

# Activate the 1Code environment (inherits from devyard)
cd /Users/jdeland/1code
flox activate
```

### Daily Workflow

```bash
# Activate environment (once per terminal session)
flox activate

# Then use normal commands
bun install
bun run dev
```

**Key points:**
- Flox manages: bun runtime, electron binary
- Inherited from devyard: TypeScript LSP, Node.js, Python, kubectl, etc.
- package.json manages: React, Electron libraries, UI components, all npm packages
- Run `flox activate` once per terminal session (or use direnv for auto-activation)
- The environment sets `ELECTRON_SKIP_BINARY_DOWNLOAD=1` to prevent duplicate electron binaries

**Without Flox:** The app will try to use system-installed bun/electron, which may have version mismatches. Always activate Flox before development.
```

**README.md updates:**

Update the "Installation" section to add Flox prerequisite. Replace lines 18-30 with:

```markdown
## Installation

### Prerequisites

- **Flox** - For reproducible development environment ([install instructions](https://flox.dev/docs))
- **Devyard environment** - 1code inherits TypeScript tooling from the devyard Flox environment (must be at `../devyard` relative to 1code)
- **Python 3** - For native module compilation (inherited from devyard)
- **Xcode Command Line Tools** (macOS) - Run `xcode-select --install`

### Option 1: Build from source (free)

```bash
# 1. Activate Flox environment (manages bun, electron, inherits from devyard)
cd /path/to/1code
flox activate

# 2. Install JavaScript dependencies
bun install

# 3. Download Claude binary (required for agent functionality)
bun run claude:download

# 4. Build and package
bun run build
bun run package:mac  # or package:win, package:linux
```

> **Important:** The Flox environment provides bun, electron, and inherits TypeScript LSP from devyard. The `claude:download` step downloads the Claude CLI binary which is required for agent chat functionality.

### Option 2: Subscribe to 1code.dev (recommended)

Get pre-built releases + background agents support by subscribing at [1code.dev](https://1code.dev).
```

Update the "Development" section (around line 38):

```markdown
## Development

```bash
# First time setup
flox activate
bun install
bun run claude:download  # First time only

# Daily workflow
flox activate  # Once per terminal session
bun run dev
```
```

**Why these changes:**
- CLAUDE.md: Detailed explanation of inheritance pattern (devyard → 1code)
- CLAUDE.md: ASCII diagram showing what's inherited vs. what's 1code-specific
- README.md: User-facing setup instructions with devyard prerequisite
- Both: Emphasize that Flox activation is once per session, not per command
- Clarify the system/application dependency boundary and inheritance hierarchy
  </action>
  <verify>
1. Check CLAUDE.md has Flox section: `grep -A 5 "Development Environment" CLAUDE.md`
2. Check CLAUDE.md mentions devyard: `grep "devyard" CLAUDE.md`
3. Check README.md updated prerequisites: `grep -A 5 "Prerequisites" README.md`
4. Check README.md mentions devyard: `grep "Devyard" README.md`
5. Verify ELECTRON_SKIP_BINARY_DOWNLOAD mentioned: `grep "ELECTRON_SKIP" CLAUDE.md`
6. Verify flox activate in both files: `grep -c "flox activate" CLAUDE.md README.md`
  </verify>
  <done>
- CLAUDE.md contains "Development Environment" section with Flox workflow and inheritance pattern
- CLAUDE.md includes ASCII diagram showing devyard → 1code relationship
- CLAUDE.md explains what's inherited vs. what's 1code-specific
- README.md "Prerequisites" section includes Flox installation link and devyard requirement
- README.md "Installation" and "Development" sections updated with flox activate steps
- Both files mention ELECTRON_SKIP_BINARY_DOWNLOAD behavior
- Documentation accurately reflects the manifest.toml structure with [include] directive
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Flox development environment with manifest.toml using [include] directive to inherit from devyard. The 1code environment adds bun and electron while inheriting TypeScript LSP and other dev tools. Documentation updated to explain inheritance pattern.
  </what-built>
  <how-to-verify>
**1. Verify Flox environment activation with inheritance:**
```bash
cd /Users/jdeland/1code
flox activate
```
Expected: See activation message "✓ 1Code development environment activated" with bun, electron versions, and TypeScript LSP path showing it's from devyard

**2. Verify 1code-specific tools are from Flox:**
```bash
# Within activated environment
which bun
# Expected: /Users/jdeland/1code/.flox/run/.../bin/bun (1code Flox path)

which electron
# Expected: /Users/jdeland/1code/.flox/run/.../bin/electron (1code Flox path)
```

**3. Verify inherited tools from devyard:**
```bash
# Within activated environment
which typescript-language-server
# Expected: Path should show devyard in it (inherited via [include])

which nodejs
# Expected: Should be available (inherited from devyard)

typescript-language-server --version
# Expected: Should return version successfully
```

**4. Verify ELECTRON_SKIP_BINARY_DOWNLOAD is set:**
```bash
# Within activated environment
echo $ELECTRON_SKIP_BINARY_DOWNLOAD
# Expected: 1
```

**5. Verify manifest has include directive:**
```bash
grep -A 2 "\[include\]" .flox/env/manifest.toml
```
Expected: Should show `[include]` section with `{ dir = "../devyard" }`

**6. Verify existing dev workflow still works:**
```bash
# Within activated environment
bun install  # Should complete without downloading electron binary
bun run dev  # Should start the app successfully
```
Watch for:
- No "Downloading electron..." message during `bun install`
- App launches successfully with `bun run dev`
- No version mismatch errors

**7. Verify documentation accurately describes inheritance:**
- Open CLAUDE.md and check "Development Environment" section has ASCII diagram
- Verify it explains devyard inheritance pattern
- Open README.md and check prerequisites mention devyard requirement
- Confirm instructions are clear about what's inherited vs. 1code-specific

**8. Test without activation (negative test):**
```bash
# Exit Flox environment
exit

# Try running command without activation
bun --version
# This will use system bun (if installed) or fail - demonstrating Flox isolation
```

**Issues to report:**
- Activation errors or failures
- Wrong tool versions
- TypeScript language server not available (inheritance issue)
- Electron binary still downloading during `bun install`
- App not launching
- Documentation inaccuracies about inheritance
- Any "command not found" errors
- Include directive not working (devyard tools not available)
  </how-to-verify>
  <resume-signal>
Type "approved" if verification passes, or describe specific issues found for fixes.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Environment activation works:** `flox activate` succeeds with helpful message
2. **Include directive works:** devyard tools (typescript-language-server, nodejs) are available
3. **1code tools provided:** bun, electron available in PATH
4. **Version constraints respected:** electron ~33.0 matches package.json 33.4.5
5. **Duplicate prevention:** ELECTRON_SKIP_BINARY_DOWNLOAD=1 prevents npm electron download
6. **Cross-platform support:** manifest.toml declares support for macOS and Linux architectures
7. **Existing workflow preserved:** `bun run dev` works without changes
8. **Documentation complete:** Both CLAUDE.md and README.md explain Flox workflow and inheritance
9. **Manifest locked:** .flox/env/manifest.lock exists for reproducibility
10. **Inheritance verified:** typescript-language-server available without explicit declaration in 1code manifest
</verification>

<success_criteria>
**Measurable outcomes:**

1. ✅ Flox environment initializes successfully: `flox activate` exits 0
2. ✅ Include directive present: `grep "\[include\]" .flox/env/manifest.toml` returns match
3. ✅ 1code tools are from Flox: `which bun` returns `.flox/run/...` path
4. ✅ Inherited tools available: `typescript-language-server --version` succeeds
5. ✅ Electron version constraint matches: `electron --version` shows v33.x.x
6. ✅ No duplicate electron: `bun install` completes without downloading electron (watch for no "Downloading electron..." message)
7. ✅ Dev workflow unchanged: `bun run dev` launches app successfully
8. ✅ Documentation references inheritance: `grep "devyard" CLAUDE.md README.md` returns matches
9. ✅ Lockfile exists: `ls .flox/env/manifest.lock` returns success
10. ✅ Cross-platform declared: `grep "systems" .flox/env/manifest.toml` shows darwin and linux

**Quality bar:**
- Flox environment provides identical tool versions across different machines
- Inheritance from devyard works correctly (no need to redeclare TypeScript tooling)
- Documentation clearly explains what's inherited vs. what's 1code-specific
- Documentation is clear enough for new contributors to set up environment in <5 minutes
- No changes required to package.json or existing scripts
- Electron binary not duplicated (saves ~150MB disk space)
</success_criteria>

<output>
After completion, create `.planning/phases/04-flox-dev-environment/04-01-SUMMARY.md` following the standard summary template with:

- Frontmatter: phase, plan, subsystem (tooling), tags, dependency graph, tech-stack, key-files
- What was built: Flox environment with manifest.toml using [include] directive
- How it works: Inheritance pattern (devyard → 1code), system vs application dependency separation
- Key decisions: Use [include] directive for devyard inheritance, version constraints, ELECTRON_SKIP_BINARY_DOWNLOAD usage
- Integration points: CLAUDE.md and README.md documentation explaining inheritance
- Validation: Verification test results from checkpoint
- Important note: TypeScript LSP inherited from devyard (line 61-62 in devyard manifest) - no explicit declaration needed in 1code
</output>
