---
phase: 04-flox-dev-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .flox/env/manifest.toml
  - CLAUDE.md
  - README.md
autonomous: false

must_haves:
  truths:
    - "Developer can run 'flox activate' in project root successfully"
    - "Activated environment provides correct versions of bun, electron, typescript-language-server"
    - "Electron binary is not downloaded twice (npm skip works)"
    - "Existing 'bun run dev' command works within activated environment"
    - "Documentation clearly explains when to use Flox vs package.json"
  artifacts:
    - path: ".flox/env/manifest.toml"
      provides: "Flox environment specification"
      contains: "[install], [vars], [profile], [options]"
    - path: ".flox/env/manifest.lock"
      provides: "Locked dependency versions"
      min_lines: 1
    - path: "CLAUDE.md"
      provides: "Updated with Flox workflow"
      contains: "flox activate"
    - path: "README.md"
      provides: "Updated installation prerequisites"
      contains: "Flox"
  key_links:
    - from: ".flox/env/manifest.toml"
      to: "package.json electron version"
      via: "version constraint match"
      pattern: "electron.*~33\\.0"
    - from: ".flox/env/manifest.toml"
      to: "bun runtime"
      via: "ELECTRON_SKIP_BINARY_DOWNLOAD prevents duplicate"
      pattern: "ELECTRON_SKIP_BINARY_DOWNLOAD"
    - from: "CLAUDE.md"
      to: ".flox/env/manifest.toml"
      via: "documentation references actual config"
      pattern: "flox activate"
---

<objective>
Establish reproducible development environment using Flox to manage system-level dependencies (bun, electron, typescript-language-server) while keeping JavaScript packages in package.json.

Purpose: Eliminate "works on my machine" issues by declaring all system dependencies in a version-controlled manifest, following the pattern successfully used in the avatar reference project.

Output: Flox environment with manifest.toml, updated documentation explaining Flox workflow, and verified compatibility with existing dev commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flox-dev-environment/04-RESEARCH.md

# Current project files
@package.json
@CLAUDE.md
@README.md
</context>

<tasks>

<task type="auto">
  <name>Initialize Flox Environment with Manifest</name>
  <files>
    .flox/env/manifest.toml
    .flox/env/manifest.lock
  </files>
  <action>
Initialize Flox environment and create manifest.toml following the avatar reference pattern (from RESEARCH.md).

**Steps:**

1. **Initialize Flox environment:**
```bash
cd /Users/jdeland/1code
flox init --name 1code
```

2. **Install system dependencies:**
```bash
# JavaScript runtime and package manager
flox install bun@~1.2

# Electron for development (matches package.json 33.4.5)
flox install electron@~33.0

# TypeScript LSP for Claude Code SDK integration
flox install typescript-language-server
flox install typescript
```

3. **Configure manifest using flox edit:**
```bash
flox edit
```

Add the following sections to match the pattern from RESEARCH.md:

```toml
[vars]
# Indicate Flox environment is active
FLOX_ENVIRONMENT = "1"

[profile]
common = '''
  # Skip electron binary download from npm (prevents duplication)
  export ELECTRON_SKIP_BINARY_DOWNLOAD=1

  # Helpful activation message
  echo "✓ 1Code development environment activated"
  echo "  Bun: $(bun --version)"
  echo "  Electron: $(electron --version)"
'''

[options]
# Support both macOS and Linux, both architectures
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-darwin", "x86_64-linux"]
```

4. **Verify installation:**
```bash
flox activate -- which bun
flox activate -- which electron
flox activate -- which typescript-language-server
```

**Important:**
- Use separate pkg-groups for bun and electron to avoid version conflicts (flox should set this automatically)
- Keep bun version as ~1.2 (loose constraint, matches avatar pattern)
- Keep electron version as ~33.0 (matches package.json 33.4.5 - major.minor match)
- Do NOT add npm packages to manifest.toml - those stay in package.json
- The ELECTRON_SKIP_BINARY_DOWNLOAD=1 prevents duplicate electron binary in node_modules/electron/

**Why these versions:**
- bun ~1.2: Current stable, matches what's likely system-installed
- electron ~33.0: Matches package.json devDependencies electron 33.4.5
- typescript-language-server: Latest for LSP support with Claude Code SDK
  </action>
  <verify>
1. Check manifest exists: `ls -la .flox/env/manifest.toml`
2. Check lockfile generated: `ls -la .flox/env/manifest.lock`
3. Verify activation works: `flox activate`
4. Verify tools available: `flox activate -- bun --version`
5. Verify ELECTRON_SKIP_BINARY_DOWNLOAD set: `flox activate -- echo $ELECTRON_SKIP_BINARY_DOWNLOAD`
  </verify>
  <done>
- .flox/env/manifest.toml exists with [install], [vars], [profile], [options] sections
- .flox/env/manifest.lock exists (auto-generated)
- `flox activate` completes successfully with activation message
- bun, electron, typescript-language-server are available in activated environment
- ELECTRON_SKIP_BINARY_DOWNLOAD=1 is set in activated shell
  </done>
</task>

<task type="auto">
  <name>Update Documentation with Flox Workflow</name>
  <files>
    CLAUDE.md
    README.md
  </files>
  <action>
Update CLAUDE.md and README.md to document the Flox workflow, following the pattern from RESEARCH.md.

**CLAUDE.md updates:**

Add a new section after the "Commands" section (around line 30):

```markdown
## Development Environment

This project uses **Flox** for reproducible development environments. Flox manages system-level tools (bun, electron, typescript-language-server) while package.json manages JavaScript dependencies.

### First-time Setup

```bash
# Install Flox (if not already installed)
curl -fsSL https://install.flox.dev | bash

# Activate the 1Code environment
cd /Users/jdeland/1code
flox activate
```

### Daily Workflow

```bash
# Activate environment (once per terminal session)
flox activate

# Then use normal commands
bun install
bun run dev
```

**Key points:**
- Flox manages: bun runtime, electron binary, TypeScript LSP
- package.json manages: React, Electron libraries, UI components, all npm packages
- Run `flox activate` once per terminal session (or use direnv for auto-activation)
- The environment sets `ELECTRON_SKIP_BINARY_DOWNLOAD=1` to prevent duplicate electron binaries

**Without Flox:** The app will try to use system-installed bun/electron, which may have version mismatches. Always activate Flox before development.
```

**README.md updates:**

Update the "Installation" section to add Flox prerequisite. Replace lines 18-30 with:

```markdown
## Installation

### Prerequisites

- **Flox** - For reproducible development environment ([install instructions](https://flox.dev/docs))
- **Python 3** - For native module compilation (pre-installed on macOS/Linux)
- **Xcode Command Line Tools** (macOS) - Run `xcode-select --install`

### Option 1: Build from source (free)

```bash
# 1. Activate Flox environment (manages bun, electron, etc.)
cd /path/to/1code
flox activate

# 2. Install JavaScript dependencies
bun install

# 3. Download Claude binary (required for agent functionality)
bun run claude:download

# 4. Build and package
bun run build
bun run package:mac  # or package:win, package:linux
```

> **Important:** The Flox environment provides bun, electron, and build tools. The `claude:download` step downloads the Claude CLI binary which is required for agent chat functionality.

### Option 2: Subscribe to 1code.dev (recommended)

Get pre-built releases + background agents support by subscribing at [1code.dev](https://1code.dev).
```

Update the "Development" section (around line 38):

```markdown
## Development

```bash
# First time setup
flox activate
bun install
bun run claude:download  # First time only

# Daily workflow
flox activate  # Once per terminal session
bun run dev
```
```

**Why these changes:**
- CLAUDE.md: Detailed explanation of Flox vs package.json separation for Claude working on the codebase
- README.md: User-facing setup instructions with Flox as first step
- Both: Emphasize that Flox activation is once per session, not per command
- Clarify the system/application dependency boundary
  </action>
  <verify>
1. Check CLAUDE.md has Flox section: `grep -A 5 "Development Environment" CLAUDE.md`
2. Check README.md updated prerequisites: `grep -A 3 "Prerequisites" README.md`
3. Verify ELECTRON_SKIP_BINARY_DOWNLOAD mentioned: `grep "ELECTRON_SKIP" CLAUDE.md`
4. Verify flox activate in both files: `grep -c "flox activate" CLAUDE.md README.md`
  </verify>
  <done>
- CLAUDE.md contains "Development Environment" section with Flox workflow explanation
- CLAUDE.md explains system vs application dependency separation
- README.md "Prerequisites" section includes Flox installation link
- README.md "Installation" and "Development" sections updated with flox activate steps
- Both files mention ELECTRON_SKIP_BINARY_DOWNLOAD behavior
- Documentation accurately reflects the manifest.toml structure created in Task 1
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Flox development environment with manifest.toml specifying bun, electron, and typescript-language-server. Documentation updated to explain Flox workflow and system/application dependency separation.
  </what-built>
  <how-to-verify>
**1. Verify Flox environment activation:**
```bash
cd /Users/jdeland/1code
flox activate
```
Expected: See activation message "✓ 1Code development environment activated" with bun and electron versions

**2. Verify tools are from Flox (not system):**
```bash
# Within activated environment
which bun
# Expected: /Users/jdeland/1code/.flox/run/.../bin/bun (Flox path)

which electron
# Expected: /Users/jdeland/1code/.flox/run/.../bin/electron (Flox path)

which typescript-language-server
# Expected: /Users/jdeland/1code/.flox/run/.../bin/typescript-language-server
```

**3. Verify ELECTRON_SKIP_BINARY_DOWNLOAD is set:**
```bash
# Within activated environment
echo $ELECTRON_SKIP_BINARY_DOWNLOAD
# Expected: 1
```

**4. Verify existing dev workflow still works:**
```bash
# Within activated environment
bun install  # Should complete without downloading electron binary
bun run dev  # Should start the app successfully
```
Watch for:
- No "Downloading electron..." message during `bun install`
- App launches successfully with `bun run dev`
- No version mismatch errors

**5. Verify documentation is accurate:**
- Open CLAUDE.md and check "Development Environment" section matches the actual Flox setup
- Open README.md and check prerequisites mention Flox with install link
- Confirm instructions are clear and complete

**6. Test without activation (negative test):**
```bash
# Exit Flox environment
exit

# Try running command without activation
bun --version
# This will use system bun (if installed) or fail - demonstrating Flox isolation
```

**Issues to report:**
- Activation errors or failures
- Wrong tool versions
- Electron binary still downloading during `bun install`
- App not launching
- Documentation inaccuracies
- Any "command not found" errors
  </how-to-verify>
  <resume-signal>
Type "approved" if verification passes, or describe specific issues found for fixes.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Environment activation works:** `flox activate` succeeds with helpful message
2. **Tools provided:** bun, electron, typescript-language-server available in PATH
3. **Version constraints respected:** electron ~33.0 matches package.json 33.4.5
4. **Duplicate prevention:** ELECTRON_SKIP_BINARY_DOWNLOAD=1 prevents npm electron download
5. **Cross-platform support:** manifest.toml declares support for macOS and Linux architectures
6. **Existing workflow preserved:** `bun run dev` works without changes
7. **Documentation complete:** Both CLAUDE.md and README.md explain Flox workflow
8. **Manifest locked:** .flox/env/manifest.lock exists for reproducibility
</verification>

<success_criteria>
**Measurable outcomes:**

1. ✅ Flox environment initializes successfully: `flox activate` exits 0
2. ✅ Tools are from Flox not system: `which bun` returns `.flox/run/...` path
3. ✅ Electron version constraint matches: `electron --version` shows v33.x.x
4. ✅ No duplicate electron: `bun install` completes without downloading electron (watch for no "Downloading electron..." message)
5. ✅ Dev workflow unchanged: `bun run dev` launches app successfully
6. ✅ Documentation references Flox: `grep -c "flox activate" CLAUDE.md README.md` returns >0 for both
7. ✅ Lockfile exists: `ls .flox/env/manifest.lock` returns success
8. ✅ Cross-platform declared: `grep "systems" .flox/env/manifest.toml` shows darwin and linux

**Quality bar:**
- Flox environment provides identical tool versions across different machines
- Documentation is clear enough for new contributors to set up environment in <5 minutes
- No changes required to package.json or existing scripts
- Electron binary not duplicated (saves ~150MB disk space)
</success_criteria>

<output>
After completion, create `.planning/phases/04-flox-dev-environment/04-01-SUMMARY.md` following the standard summary template with:

- Frontmatter: phase, plan, subsystem (tooling), tags, dependency graph, tech-stack, key-files
- What was built: Flox environment with manifest.toml
- How it works: System vs application dependency separation pattern
- Key decisions: Version constraints, ELECTRON_SKIP_BINARY_DOWNLOAD usage
- Integration points: CLAUDE.md and README.md documentation
- Validation: Verification test results from checkpoint
</output>
